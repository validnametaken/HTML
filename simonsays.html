<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon Says Game</title>
    <style>

body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: black;
    transition: background-color 0.3s ease;
    margin: 0;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: white;
    overscroll-behavior: contain;
    position: fixed;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
}

.game-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    width: min(60vh, 800px);
    height: min(60vh, 800px);
    margin: 20px auto;
    gap: min(30px, 4vw);
}

#score, .speed-settings, #start-btn {
    max-width: min(60vh, 800px);
    margin: 20px auto;
}

@media screen and (max-width: 480px) {
    .game-container {
        width: min(90vw, 300px);
        height: min(90vw, 300px);
        gap: 20px;
    }
}

.button {
    width: 100%;
    padding-bottom: 100%;
    border-radius: 15px;
    cursor: pointer;
    transition: transform 0.2s ease;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    border: 3px solid rgba(255, 255, 255, 0.1);
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
}



.button:hover {
    transform: scale(1.05);
}

#green { background-color: #00c853; }
#red { background-color: #ff1744; }
#yellow { background-color: #ffd600; }
#blue { background-color: #2979ff; }

.button.active { 
    filter: brightness(160%);
    box-shadow: 0 0 30px currentColor;
    transition: none;
}

#start-btn {
    display: block;
    margin: 20px auto;
    padding: 15px 40px;
    font-size: 18px;
    cursor: pointer;
    background: linear-gradient(45deg, #2979ff, #00c853);
    border: none;
    border-radius: 25px;
    color: white;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

#start-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

#score {
    text-align: center;
    font-size: clamp(16px, 2vw, 24px);
    margin-top: 20px;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

.speed-settings {
    text-align: center;
    margin: 20px auto;
}

#game-speed {
    padding: 10px 20px;
    font-size: 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    color: white;
    cursor: pointer;
    margin-left: 10px;
}

#game-speed option {
    background-color: #1a1a1a;
}

    </style>
</head>
<body>
    <div id="score">Scoreee: 0</div>
    <div class="speed-settings">
        <label for="game-speed">Game Speed:</label>
        <select id="game-speed">
            <option value="2000">Slow</option>
            <option value="1000">Normal</option>
            <option value="500">Fast</option>
            <option value="100">Blazing</option>
        </select>
    </div>
    

    <div class="game-container">
        <div class="button" id="green" data-color="green"></div>
        <div class="button" id="red" data-color="red"></div>
        <div class="button" id="yellow" data-color="yellow"></div>
        <div class="button" id="blue" data-color="blue"></div>
    </div>
    <button id="start-btn">Start Game</button>

    <script>
 const GAME_CONSTANTS = {
    COLORS: ['green', 'red', 'yellow', 'blue'],
    SPEEDS: {
        SLOW: 2000,
        NORMAL: 1000,
        FAST: 500,
        BLAZING: 100
    }
};

const GameStates = {
    LOADING: 'loading',
    READY: 'ready',
    PLAYING: 'playing',
    GAME_OVER: 'gameOver'
};

const gameState = {
    sequence: [],
    playerSequence: [],
    score: 0,
    gameSpeed: GAME_CONSTANTS.SPEEDS.NORMAL,
    currentState: GameStates.LOADING
};

const audioContext = new (window.AudioContext || window.webkitAudioContext)();
const buffers = {};
const soundCache = new Map();

const prewarmAudio = (buffer) => {
    const source = audioContext.createBufferSource();
    source.buffer = buffer;
    source.connect(audioContext.destination);
    source.start(0);
    source.stop(0.001);
};

async function loadSounds(retries = 3) {
    while (retries > 0) {
        try {
            for (const color of GAME_CONSTANTS.COLORS) {
                const response = await fetch(`simonSounds/simonSound${GAME_CONSTANTS.COLORS.indexOf(color) + 1}.mp3`);
                if (!response.ok) throw new Error(`Failed to load sound for ${color}`);
                const arrayBuffer = await response.arrayBuffer();
                buffers[color] = await audioContext.decodeAudioData(arrayBuffer);
                // Prewarm the audio buffer
                prewarmAudio(buffers[color]);
                soundCache.set(color, true);
            }
            return true;
        } catch (error) {
            retries--;
            if (retries === 0) {
                console.error('Sound loading failed:', error);
                alert('Failed to load game sounds. Please refresh the page.');
                return false;
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
}

function playSound(color) {
    if (!soundCache.has(color)) return;
    const source = audioContext.createBufferSource();
    source.buffer = buffers[color];
    source.connect(audioContext.destination);
    source.start(0);
    return source;
}

const buttons = document.querySelectorAll('.button');
const startButton = document.getElementById('start-btn');
const scoreDisplay = document.getElementById('score');
const speedSelector = document.getElementById('game-speed');

function debouncePlayerInput(fn, delay) {
    let timeoutId;
    return (...args) => {
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), delay);
    };
}
function unlockAudioContext() {
    const silentBuffer = audioContext.createBuffer(1, 1, 22050);
    const source = audioContext.createBufferSource();
    source.buffer = silentBuffer;
    source.connect(audioContext.destination);
    source.start(0);
}

document.addEventListener('touchstart', function() {
    if (audioContext.state === 'suspended') {
        unlockAudioContext();
    }
}, {once: true});


speedSelector.addEventListener('change', updateGameSpeed);
startButton.addEventListener('click', startGame);
buttons.forEach(button => {
    const handleInput = debouncePlayerInput(() => playerTurn(button), 200);
    button.addEventListener('click', handleInput);
    button.addEventListener('touchstart', (e) => {
        e.preventDefault(); // Prevents double-firing on iOS
        handleInput();
    });
});

function updateGameSpeed() {
    gameState.gameSpeed = parseInt(speedSelector.value);
}

async function playSequence() {
    gameState.currentState = GameStates.PLAYING;
    document.body.style.backgroundColor = '#1a0033';
    for (let i = 0; i < gameState.sequence.length; i++) {
        const color = gameState.sequence[i];
        const button = document.querySelector(`[data-color="${color}"]`);
        button.classList.add('active');
        playSound(color);
        await new Promise(resolve => setTimeout(resolve, gameState.gameSpeed/4));
        button.classList.remove('active');
        if (i < gameState.sequence.length - 1) {
            await new Promise(resolve => setTimeout(resolve, gameState.gameSpeed/4));
        }
    }
    document.body.style.backgroundColor = 'black';
    gameState.currentState = GameStates.READY;
    enablePlayerInput();
}

function startGame() {
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    document.body.style.backgroundColor = 'black';
    updateGameSpeed();
    gameState.sequence = [];
    gameState.playerSequence = [];
    gameState.score = 0;
    gameState.currentState = GameStates.READY;
    scoreDisplay.textContent = `Score: ${gameState.score}`;
    addToSequence();
}

function addToSequence() {
    const random = GAME_CONSTANTS.COLORS[Math.floor(Math.random() * GAME_CONSTANTS.COLORS.length)];
    gameState.sequence.push(random);
    playSequence();
}

function enablePlayerInput() {
    if (gameState.currentState === GameStates.READY) {
        buttons.forEach(button => {
            button.style.pointerEvents = 'auto';
        });
    }
}

function disablePlayerInput() {
    buttons.forEach(button => {
        button.style.pointerEvents = 'none';
    });
}

function playerTurn(button) {
    if (gameState.currentState !== GameStates.READY) return;
    
    const color = button.dataset.color;
    button.classList.add('active');
    playSound(color);
    setTimeout(() => button.classList.remove('active'), gameState.gameSpeed/4);
    
    gameState.playerSequence.push(color);

    if (gameState.playerSequence[gameState.playerSequence.length - 1] !== gameState.sequence[gameState.playerSequence.length - 1]) {
        gameState.currentState = GameStates.GAME_OVER;
        alert('Game Over! Click Start to play again.');
        return;
    }

    if (gameState.playerSequence.length === gameState.sequence.length) {
        disablePlayerInput();
        gameState.playerSequence = [];
        gameState.score++;
        scoreDisplay.textContent = `Score: ${gameState.score}`;
        setTimeout(() => {
            addToSequence();
        }, 1000);
    }
}

// Initialize sounds when page loads
startButton.textContent = 'Loading...';
gameState.currentState = GameStates.LOADING;
loadSounds().then((success) => {
    if (success) {
        startButton.disabled = false;
        startButton.textContent = 'Start Game';
        gameState.currentState = GameStates.READY;
    }
});

    </script>
</body>
</html>
